{{ $defaults := .Values.defaults -}}
---
{{ range $applicationTeams := .Values.applicationTeams -}}
---
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: "{{ $applicationTeams.teamName }}-project"
  namespace: d2-application-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  sourceNamespaces:
  - "{{ $applicationTeams.teamName }}-team"
  description: "{{ $applicationTeams.teamName }} users project"
  sourceRepos: 
  {{ toYaml $applicationTeams.appProject.repos | nindent 2 }}
  clusterResourceWhitelist:
  - group: '*'
    kind: Namespace
  {{- if $applicationTeams.appProject.clusterResourceWhitelist }}
  {{ toYaml $applicationTeams.appProject.clusterResourceWhitelist | nindent 2 }}
  {{- end }}
  destinations:
  - namespace: "{{ $applicationTeams.teamName }}*"
    server: 'https://kubernetes.default.svc'
  {{- if $applicationTeams.appProject.destinations }}
  {{ toYaml $applicationTeams.appProject.destinations | nindent 2 }}
  {{- end }}
  roles:
  {{- if $applicationTeams.appProject.roles }}
  {{ toYaml $applicationTeams.appProject.roles | nindent 2 }}
  {{- else }}
  - name: 'all-app-actions'
    description: Application privliges to my-project
    policies:
    - p, proj:{{ $applicationTeams.teamName }}-project:all-app-actions, applications, *, {{ $applicationTeams.teamName }}-project/*, allow
    groups:
    - {{ $applicationTeams.appProject.adGroup }}
  {{- end }}
{{- end }}


