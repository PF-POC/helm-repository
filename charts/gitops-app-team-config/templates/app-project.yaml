---
{{ $team := .Values.team -}}
---
{{ $defaults := .Values.defaults -}}
---
{{ $repos := $defaults.repositories -}}
---
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: "main-app-project"
  namespace: openshift-gitops
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  description: "{{ $team.name }} users project"
  sourceRepos:
  {{- range $repos }}
    - {{ . | quote }}
  {{- end }}
  clusterResourceWhitelist:
    - group: '*'
      kind: '*'
  destinations:
    - namespace: '*'
      server: "{{ $defaults.server }}"
    - namespace: "openshift-gitops"
      server: "https://kubernetes.default.svc"
  roles:
    - name: users
      description: "Application teams privilleges for project {{ $team.name }}-{{ $team.tier }}-users"
      policies:
        - "p, proj:{{ $team.name }}-users:users, applications, *, {{ $team.name }}-{{ $team.tier }}-users/*, allow"
      groups:
        - "{{ $defaults.adGroup }}"
    # - name: users-deny
    #   description: "Application teams privilleges for project `{{ $team.name }}-{{ $team.tier }}-users`"
    #   policies:
    #     - "p, proj:{{ $team.name }}-{{ $team.tier }}-users:users, applications, *, {{ $team.name }}-{{ $team.tier }}  , deny"
    #   groups:
    #     - "{{ $team.adGroup }}"
    # - name: admin 
    #   description: "admin privilleges for project `{{ $team.name }}-{{ $team.tier }}-users`"
    #   policies:
    #     - "p, proj:{{ $team.name }}-{{ $team.tier }}-users:admin, applications, *, {{ $team.name }}-{{ $team.tier }}-admin/*, allow"
    #     - "p, proj:{{ $team.name }}-{{ $team.tier }}-users:admin, teams, get, {{ $team.name }}-{{ $team.tier }}-admin, allow"
    #   groups:
    #     - "{{ $team.server }}"